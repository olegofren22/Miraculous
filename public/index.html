<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Spin Bot Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5f7fa;
      --panel: #ffffff;
      --muted: #6b7280;
      --text: #1f2937;
      --accent: #2563eb;
      --good: #059669;
      --warn: #d97706;
      --bad: #dc2626;
      --chip: #e5e7eb;
      --border: #e2e8f0;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    h1 { margin: 0; font-size: 24px; font-weight: 600; }
    .accent { color: var(--accent); }
    .wrap { padding: 24px; max-width: 1400px; margin: 0 auto; }
    .card { 
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px; 
      overflow: hidden; 
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .card h2 { 
      font-size: 16px; 
      font-weight: 600;
      margin: 0; 
      padding: 16px 20px; 
      border-bottom: 1px solid var(--border); 
      background: #f9fafb;
    }
    .section { padding: 20px; }
    .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
    .btn {
      background: white; 
      border: 1px solid var(--border); 
      color: var(--text);
      padding: 8px 16px; 
      border-radius: 8px; 
      cursor: pointer; 
      transition: all .15s;
      font-size: 14px;
      font-weight: 500;
    }
    .btn:hover { 
      border-color: var(--accent); 
      color: var(--accent);
      background: #f8fafc;
    }
    .btn.small { padding: 4px 10px; font-size: 12px; }
    .btn.primary { background: var(--accent); border-color: var(--accent); color: white; }
    .btn.primary:hover { background: #1d4ed8; }
    .btn.success { background: var(--good); border-color: var(--good); color: white; }
    .btn.warning { background: var(--warn); border-color: var(--warn); color: white; }
    .btn.danger { background: var(--bad); border-color: var(--bad); color: white; }
    .btn.info { background: #6b7280; border-color: #6b7280; color: white; }
    .user-card {
      background: #f9fafb; 
      border: 1px solid var(--border); 
      border-radius: 10px; 
      padding: 16px; 
      margin-bottom: 12px;
    }
    .user-head { display: flex; gap: 16px; align-items: center; justify-content: space-between; }
    .user-head h3 { margin: 0; font-size: 16px; font-weight: 600; color: var(--accent); }
    .user-nick {
      font-size: 14px;
      color: var(--muted);
      margin-left: 4px;
      font-weight: normal;
    }
    .kv { 
      display: grid; 
      grid-template-columns: 140px 1fr 140px 1fr; 
      gap: 12px 16px; 
      margin: 12px 0; 
      font-size: 13px; 
    }
    .muted { color: var(--muted); }
    .ok { color: var(--good); }
    .bad { color: var(--bad); }
    .warn { color: var(--warn); }
    .jwt-token {
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      font-size: 8px;
      color: #4b5563;
      background: #f3f4f6;
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #e5e7eb;
      width: 100%;
      overflow-x: auto;
      white-space: nowrap;
      margin: 8px 0;
      user-select: all;
    }
    pre.logs {
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      white-space: pre-wrap; 
      background: #f8fafc; 
      border: 1px solid var(--border);
      padding: 16px; 
      border-radius: 8px; 
      max-height: 400px; 
      overflow: auto; 
      font-size: 12px;
      color: #1e293b;
      line-height: 1.6;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: var(--panel);
      padding: 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }
    .stat-value {
      font-size: 28px;
      font-weight: 600;
      color: var(--accent);
      line-height: 1.2;
    }
    .stat-label {
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
    }
    .progress-bar {
      width: 100%;
      height: 4px;
      background: var(--chip);
      border-radius: 2px;
      margin-top: 8px;
    }
    .progress-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      transition: width 0.3s ease;
    }
    .settings-panel {
      display: flex;
      gap: 24px;
      align-items: center;
      flex-wrap: wrap;
    }
    .input-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .input-group label {
      font-size: 13px;
      font-weight: 500;
      color: var(--muted);
      min-width: 80px;
    }
    .input-group input {
      background: white;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 6px;
      width: 100px;
      font-size: 14px;
    }
    .input-group input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .badge-idle { background: #e5e7eb; color: #374151; }
    .badge-refreshing { background: #fef3c7; color: #92400e; }
    .badge-claiming { background: #ede9fe; color: #5b21b6; }
    .badge-checking { background: #dbeafe; color: #1e40af; }
    .badge-spinning { background: #cffafe; color: #155e75; }
    .badge-ready { background: #d1fae5; color: #065f46; }
    .badge-completed { background: #9ca3af; color: #1f2937; }
    .badge-error { background: #fee2e2; color: #991b1b; }
    .funds-diff {
      font-size: 11px;
      margin-left: 4px;
    }
    .positive { color: var(--good); }
    .negative { color: var(--bad); }
  </style>
</head>
<body>
  <header>
    <h1>Spin Bot <span class="accent">Dashboard</span></h1>
    <div class="row">
      <button class="btn" id="refreshAll">üîÑ Refresh</button>
      <button class="btn info" id="checkAllFunds">üí∞ Check All Funds</button>
    </div>
  </header>

  <div class="wrap">
    <!-- System Stats -->
    <div class="stats-grid" id="systemStats">
      <div class="stat-card">
        <div class="stat-value" id="totalUsers">0</div>
        <div class="stat-label">Total Users</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="activeCount">0</div>
        <div class="stat-label">Active in Pool</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="queueLength">0</div>
        <div class="stat-label">In Queue</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalSpins">0</div>
        <div class="stat-label">Total Spins</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalPacks">0</div>
        <div class="stat-label">Total Packs</div>
      </div>
    </div>

    <!-- Control Panel -->
    <div class="card">
      <h2>Control Panel</h2>
      <div class="section">
        <div class="settings-panel">
          <div class="input-group">
            <label>Max Concurrent:</label>
            <input type="number" id="maxConcurrent" min="1" max="50" value="5">
          </div>
          <div class="input-group">
            <label>Spin Delay (s):</label>
            <input type="number" id="spinDelay" min="1" max="30" step="0.1" value="7">
          </div>
          <div class="input-group">
            <label>Min Funds:</label>
            <input type="number" id="minFunds" min="1000" max="1000000" step="1000" value="10000">
          </div>
          <button class="btn success" id="startButton">‚ñ∂Ô∏è Start</button>
          <button class="btn warning" id="pauseButton">‚è∏Ô∏è Pause</button>
          <button class="btn danger" id="resetButton">üîÑ Reset Stats</button>
        </div>
        <div class="row" style="margin-top: 16px;">
          <span class="status-badge" id="systemStatus">System Ready</span>
          <span class="muted" id="statusDetail"></span>
        </div>
      </div>
    </div>

    <!-- Users Panel -->
    <div class="card">
      <h2>Users</h2>
      <div class="section" id="usersPanel">
        <div class="muted">Loading users...</div>
      </div>
    </div>

    <!-- Activity Logs -->
    <div class="card">
      <h2>Activity Logs</h2>
      <div class="section">
        <div class="row" style="margin-bottom:16px; justify-content:space-between;">
          <button class="btn small" id="refreshLogs">Refresh Logs</button>
          <span class="muted">Showing latest events</span>
        </div>
        <pre class="logs" id="logsBox">Loading logs...</pre>
      </div>
    </div>
  </div>

  <script>
    // State
    let systemState = {
      isPaused: false,
      settings: {
        maxConcurrent: 5,
        spinDelay: 7,
        minFundsThreshold: 10000
      },
      activeCount: 0,
      queueLength: 0,
      totalUsers: 0
    };

    let autoRefresh = true;
    let lastScrollPosition = 0;

    // API Functions
    async function fetchUsers() {
      const r = await fetch('/api/users');
      if (!r.ok) throw new Error('Failed to fetch users');
      return r.json();
    }

    async function fetchDebugLogs(limit = 100) {
      const r = await fetch(`/api/debug-logs?limit=${limit}`);
      if (!r.ok) throw new Error('Failed to fetch logs');
      return r.json();
    }

    async function fetchSystemState() {
      const r = await fetch('/api/system-state');
      if (!r.ok) throw new Error('Failed to fetch system state');
      return r.json();
    }

    async function sendCommand(endpoint, body = {}) {
      const r = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      return r.json();
    }

    // Render Functions
    function renderUsers(users) {
      const panel = document.getElementById('usersPanel');
      const userIds = Object.keys(users).sort();
      
      if (!userIds.length) {
        panel.innerHTML = '<div class="muted">No users loaded.</div>';
        return;
      }

      // Calculate totals
      const totals = {
        totalSpins: userIds.reduce((sum, id) => sum + (users[id].totalSpinsRun || 0), 0),
        totalPacks: userIds.reduce((sum, id) => sum + (users[id].totalPacksOpened || 0), 0)
      };

      document.getElementById('totalSpins').textContent = totals.totalSpins;
      document.getElementById('totalPacks').textContent = totals.totalPacks;

      const parts = [];

      userIds.forEach((id) => {
        const u = users[id];
        const statusClass = `badge-${u.status || 'idle'}`;
        const progressPercent = u.spinsRemaining ? ((u.spinsDoneInRound || 0) / ((u.spinsDoneInRound || 0) + u.spinsRemaining) * 100) : 0;
        
        // Calculate funds difference
        const fundsDiff = u.currentFunds - u.initialFunds;
        const diffClass = fundsDiff > 0 ? 'positive' : (fundsDiff < 0 ? 'negative' : '');
        const diffSign = fundsDiff > 0 ? '+' : '';
        
        parts.push(`
          <div class="user-card">
            <div class="user-head">
              <div style="display:flex; align-items:center; gap:8px;">
                <h3>${id} <span class="user-nick">${u.nick || ''}</span></h3>
                <span class="status-badge ${statusClass}">${u.status || 'idle'}</span>
              </div>
              <div class="row">
                <button class="btn small" data-act="refresh" data-id="${id}">üîÑ Refresh Token</button>
                <button class="btn small" data-act="check-funds" data-id="${id}">üí∞ Check Funds</button>
              </div>
            </div>
            
            <!-- Full JWT token for copying -->
            <div class="jwt-token" title="Select all to copy">
              ${u.jwtToken || 'No token'}
            </div>
            
            <div class="kv">
              <span class="muted">Status</span>
              <span>${u.isActive ? '‚úÖ Active' : '‚ùå Inactive'}</span>
              <span class="muted">Spins (Total/Round)</span>
              <span>${u.totalSpinsRun || 0} / ${u.spinsDoneInRound || 0} of ${(u.spinsDoneInRound || 0) + (u.spinsRemaining || 0)}</span>
              
              <span class="muted">Initial Funds</span>
              <span>${(u.initialFunds || 0).toLocaleString()}</span>
              <span class="muted">Current Funds</span>
              <span>
                ${(u.currentFunds || 0).toLocaleString()}
                <span class="funds-diff ${diffClass}">(${diffSign}${fundsDiff.toLocaleString()})</span>
              </span>
              
              <span class="muted">Packs Opened</span>
              <span>${u.totalPacksOpened || 0}</span>
              <span class="muted">Achievements</span>
              <span>${u.achievementsClaimed || 0}</span>
              
              <span class="muted">Last Error</span>
              <span class="${u.lastError ? 'bad' : 'muted'}">${u.lastError || 'None'}</span>
            </div>
            
            ${(u.spinsRemaining || 0) > 0 ? `
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progressPercent}%"></div>
            </div>
            ` : ''}
            
            ${u.startTime ? `
            <div style="margin-top:8px; font-size:11px; color:var(--muted);">
              Started: ${new Date(u.startTime).toLocaleTimeString()}
              ${u.endTime ? ` ¬∑ Completed: ${new Date(u.endTime).toLocaleTimeString()}` : ''}
            </div>
            ` : ''}
          </div>
        `);
      });

      panel.innerHTML = parts.join('\n');
      
      // Add event listeners
      panel.querySelectorAll('button[data-act="refresh"]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          try {
            await sendCommand(`/api/user/${id}/refresh`);
            await loadAll();
          } catch (err) {
            alert(err.message);
          }
        });
      });
      
      panel.querySelectorAll('button[data-act="check-funds"]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          try {
            await sendCommand(`/api/user/${id}/check-funds`);
            await loadAll();
          } catch (err) {
            alert(err.message);
          }
        });
      });
    }

    function renderLogs(logs) {
      const box = document.getElementById('logsBox');
      if (!logs || !logs.length) {
        box.textContent = 'No logs yet.';
        return;
      }
      
      // Save scroll position
      lastScrollPosition = box.scrollTop;
      
      const lines = logs.map(entry => {
        const time = entry.timestamp ? new Date(entry.timestamp).toLocaleTimeString() : '';
        return `[${time}] [${entry.type || 'INFO'}] ${entry.userId}: ${entry.message}`;
      });
      
      box.textContent = lines.join('\n');
      
      // Restore scroll position
      box.scrollTop = lastScrollPosition;
    }

    function updateSystemStats(state) {
      document.getElementById('totalUsers').textContent = state.totalUsers || 0;
      document.getElementById('activeCount').textContent = state.activeCount || 0;
      document.getElementById('queueLength').textContent = state.queueLength || 0;
      
      const systemStatus = document.getElementById('systemStatus');
      systemStatus.textContent = state.isPaused ? '‚è∏Ô∏è PAUSED' : (state.activeCount > 0 ? '‚ñ∂Ô∏è RUNNING' : '‚èπÔ∏è STOPPED');
      systemStatus.className = `status-badge ${state.isPaused ? 'badge-warning' : (state.activeCount > 0 ? 'badge-spinning' : 'badge-idle')}`;
      
      document.getElementById('statusDetail').textContent = 
        `Max: ${state.settings.maxConcurrent}, Delay: ${state.settings.spinDelay}s, Min: ${state.settings.minFundsThreshold}`;
    }

    // Load Functions
    async function loadAll() {
      try {
        const [users, logs, state] = await Promise.all([
          fetchUsers(),
          fetchDebugLogs(100),
          fetchSystemState()
        ]);
        
        systemState = state;
        updateSystemStats(state);
        renderUsers(users);
        renderLogs(logs);
      } catch (err) {
        console.error('Failed to load:', err);
      }
    }

    // Event Listeners
    document.getElementById('refreshAll').addEventListener('click', () => {
      autoRefresh = false;
      loadAll();
      setTimeout(() => { autoRefresh = true; }, 1000);
    });
    
    document.getElementById('checkAllFunds').addEventListener('click', async () => {
      await sendCommand('/api/check-all-funds');
      await loadAll();
    });
    
    document.getElementById('refreshLogs').addEventListener('click', async () => {
      const logs = await fetchDebugLogs(100);
      renderLogs(logs);
    });

    document.getElementById('startButton').addEventListener('click', async () => {
      const maxConcurrent = document.getElementById('maxConcurrent').value;
      const spinDelay = document.getElementById('spinDelay').value;
      const minFundsThreshold = document.getElementById('minFunds').value;
      
      await sendCommand('/api/start', { maxConcurrent, spinDelay, minFundsThreshold });
      await loadAll();
    });

    document.getElementById('pauseButton').addEventListener('click', async () => {
      await sendCommand('/api/pause');
      await loadAll();
    });

    document.getElementById('resetButton').addEventListener('click', async () => {
      if (confirm('Reset all statistics? User tokens will be preserved.')) {
        await sendCommand('/api/reset');
        await loadAll();
      }
    });

    // Auto-refresh every 3 seconds
    setInterval(() => {
      if (autoRefresh) {
        loadAll();
      }
    }, 3000);

    // Initial load
    loadAll();
  </script>
</body>
</html>